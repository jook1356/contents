name: "SEO Files Auto Update"

on:
  # ì½˜í…ì¸  ë³€ê²½ì‹œ ìë™ ì‹¤í–‰
  push:
    paths:
      - "contents/boards/**"
      - "contents/boards-config.json"
      - "contents/templates/**"

  # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (UTC) / ì˜¤ì „ 11ì‹œ (KST) ìë™ ì‹¤í–‰
  schedule:
    - cron: "0 2 * * *"

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      force_update:
        description: "ê°•ì œ ì—…ë°ì´íŠ¸ (ëª¨ë“  SEO íŒŒì¼ ì¬ìƒì„±)"
        required: false
        default: "false"
        type: boolean

jobs:
  update-seo-files:
    name: "Update SEO Files"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4
        with:
          # ì „ì²´ ì»¤ë°‹ íˆìŠ¤í† ë¦¬ë¥¼ ê°€ì ¸ì™€ì„œ ë³€ê²½ì‚¬í•­ ê°ì§€ ê°€ëŠ¥
          fetch-depth: 0

      - name: "ğŸ—ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: "ğŸ“Š Analyze content changes"
        id: changes
        run: |
          echo "ğŸ” ì½˜í…ì¸  ë³€ê²½ì‚¬í•­ ë¶„ì„ ì¤‘..."

          # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})
            echo "ë³€ê²½ëœ íŒŒì¼ë“¤:"
            echo "$CHANGED_FILES"
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "scheduled=true" >> $GITHUB_OUTPUT
            echo "ğŸ“… ì •ê¸° ì‹¤í–‰ - ëª¨ë“  SEO íŒŒì¼ ì—…ë°ì´íŠ¸"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "manual=true" >> $GITHUB_OUTPUT
            echo "ğŸ–±ï¸ ìˆ˜ë™ ì‹¤í–‰"
          fi

      - name: "ğŸ¤– Generate SEO files"
        run: |
          echo "ğŸš€ SEO íŒŒì¼ ìƒì„± ì‹œì‘..."
          npm run seo:generate

      - name: "ğŸ“‹ Check for changes"
        id: git-changes
        run: |
          # Git ìƒíƒœ í™•ì¸
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“ SEO íŒŒì¼ ë³€ê²½ì‚¬í•­ ë°œê²¬"
            echo "changes=true" >> $GITHUB_OUTPUT
            
            # ë³€ê²½ëœ íŒŒì¼ë“¤ ì¶œë ¥
            echo "ë³€ê²½ëœ íŒŒì¼ë“¤:"
            git status --porcelain
          else
            echo "âœ… SEO íŒŒì¼ì— ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ“¤ Commit and push SEO files"
        if: steps.git-changes.outputs.changes == 'true'
        run: |
          # SEO íŒŒì¼ë“¤ë§Œ ìŠ¤í…Œì´ì§•
          git add contents/sitemap.xml contents/robots.txt

          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          if [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_MSG="ğŸ¤– Auto-update SEO files after content changes"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            COMMIT_MSG="ğŸ¤– Scheduled SEO files update"
          else
            COMMIT_MSG="ğŸ¤– Manual SEO files update"
          fi

          # ì»¤ë°‹ ë° í‘¸ì‹œ
          git commit -m "$COMMIT_MSG" \
            -m "Generated by GitHub Actions" \
            -m "" \
            -m "ğŸ“Š Updated files:" \
            -m "- sitemap.xml" \
            -m "- robots.txt"

          git push

          echo "âœ… SEO íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ!"

      - name: "ğŸ“Š Summary"
        if: always()
        run: |
          echo "## ğŸ¯ SEO ì—…ë°ì´íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.git-changes.outputs.changes }}" = "true" ]; then
            echo "âœ… **ì„±ê³µ**: SEO íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ì—…ë°ì´íŠ¸ëœ íŒŒì¼" >> $GITHUB_STEP_SUMMARY
            echo "- \`contents/sitemap.xml\`" >> $GITHUB_STEP_SUMMARY 
            echo "- \`contents/robots.txt\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **ì •ë³´**: ë³€ê²½í•  SEO íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ì‹¤í–‰ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **íŠ¸ë¦¬ê±°**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY

      - name: "ğŸ” Content analysis report"
        if: github.event_name == 'push'
        run: |
          echo "## ğŸ“ˆ ì½˜í…ì¸  ë¶„ì„ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ê²Œì‹œê¸€ ê°œìˆ˜ ë¶„ì„
          TOTAL_POSTS=$(find contents/boards -name "meta.json" | wc -l)
          FRONTEND_POSTS=$(find contents/boards/frontend -name "meta.json" 2>/dev/null | wc -l || echo 0)
          BACKEND_POSTS=$(find contents/boards/backend -name "meta.json" 2>/dev/null | wc -l || echo 0)
          GENERAL_POSTS=$(find contents/boards/general -name "meta.json" 2>/dev/null | wc -l || echo 0)
          TUTORIAL_POSTS=$(find contents/boards/tutorial -name "meta.json" 2>/dev/null | wc -l || echo 0)

          echo "### ğŸ“Š ê²Œì‹œê¸€ í†µê³„" >> $GITHUB_STEP_SUMMARY
          echo "- **ì „ì²´**: ${TOTAL_POSTS}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${FRONTEND_POSTS}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${BACKEND_POSTS}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **General**: ${GENERAL_POSTS}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **Tutorial**: ${TUTORIAL_POSTS}ê°œ" >> $GITHUB_STEP_SUMMARY
